# üé® B√ÅO C√ÅO S·ª¨A L·∫†I TRANG RFQ ƒê√É G·ª¨I

**Ng√†y s·ª≠a:** 17/10/2025  
**Trang:** `/rfq/sent` - RFQ ƒë√£ g·ª≠i  
**Tr·∫°ng th√°i:** ‚úÖ HO√ÄN TH√ÄNH

---

## üéØ M·ª§C TI√äU

1. ‚úÖ S·ª≠ d·ª•ng ƒë√∫ng data th·∫≠t t·ª´ API
2. ‚úÖ C·∫£i thi·ªán giao di·ªán hi·ªÉn th·ªã
3. ‚úÖ Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß th√¥ng tin RFQ
4. ‚úÖ Fix l·ªói field names (snake_case)

---

## üîß C√ÅC THAY ƒê·ªîI CH√çNH

### **1. S·ª≠a Interface RFQ - ƒê√∫ng V·ªõi API Response**

#### ‚ùå **TR∆Ø·ªöC (Interface sai):**

```typescript
interface RFQ {
  id: string;
  listing_id: string;
  buyer_id: string;
  title?: string;              // ‚ùå Kh√¥ng c√≥ trong DB
  description?: string;        // ‚ùå Kh√¥ng c√≥ trong DB
  purpose: string;
  quantity: number;
  need_by: string | null;
  delivery_location?: string;  // ‚ùå Kh√¥ng c√≥ trong DB
  budget?: number;             // ‚ùå Kh√¥ng c√≥ trong DB
  currency?: string;           // ‚ùå Kh√¥ng c√≥ trong DB
  services_json: any;
  status: string;
  submitted_at: string;
  expired_at: string;
  listings?: {
    id: string;
    title: string;
    price_amount: number;      // ‚ùå SAI type (ph·∫£i l√† string)
    price_currency: string;
  };
  quotes?: any[];              // ‚ùå Kh√¥ng c√≥ type c·ª• th·ªÉ
}
```

#### ‚úÖ **SAU (Interface ƒë√∫ng):**

```typescript
interface RFQ {
  id: string;
  listing_id: string;
  buyer_id: string;
  purpose: string;             // ‚úÖ PURCHASE/RENTAL/INQUIRY
  quantity: number;
  need_by: string | null;
  services_json: any;          // ‚úÖ Object ch·ª©a services
  status: string;              // ‚úÖ SUBMITTED/QUOTED/ACCEPTED...
  submitted_at: string;
  expired_at: string;
  created_at: string;
  updated_at: string;
  listings?: {                 // ‚úÖ Relation t·ª´ Prisma
    id: string;
    title: string;
    price_amount: string;      // ‚úÖ ƒê√öNG: Decimal ‚Üí string
    price_currency: string;
    containers?: {             // ‚úÖ Nested relation
      type: string;
      size_ft: number;
    };
  };
  quotes?: {                   // ‚úÖ Type c·ª• th·ªÉ
    id: string;
    status: string;
    total: string;             // ‚úÖ ƒê√öNG: Decimal ‚Üí string
    currency: string;
    created_at: string;
  }[];
}
```

---

### **2. Th√™m Helper Functions**

#### **A. getPurposeLabel() - Convert Purpose Enum**

```typescript
const getPurposeLabel = (purpose: string) => {
  const purposeUpper = purpose.toUpperCase();
  switch (purposeUpper) {
    case 'PURCHASE':
    case 'SALE':
      return 'Mua';
    case 'RENTAL':
    case 'RENT':
      return 'Thu√™';
    case 'INQUIRY':
      return 'H·ªèi th√¥ng tin';
    default:
      return purpose;
  }
};
```

**V√≠ d·ª•:**
- `PURCHASE` ‚Üí "Mua"
- `RENTAL` ‚Üí "Thu√™"
- `INQUIRY` ‚Üí "H·ªèi th√¥ng tin"

#### **B. formatServices() - Parse Services JSON**

```typescript
const formatServices = (servicesJson: any) => {
  if (!servicesJson || typeof servicesJson !== 'object') return [];
  const services = [];
  if (servicesJson.inspection) services.push('Ki·ªÉm ƒë·ªãnh');
  if (servicesJson.repair_estimate) services.push('B√°o gi√° s·ª≠a ch·ªØa');
  if (servicesJson.certification) services.push('Ch·ª©ng nh·∫≠n');
  if (servicesJson.delivery_estimate) services.push('V·∫≠n chuy·ªÉn');
  return services;
};
```

**Input:**
```json
{
  "inspection": true,
  "repair_estimate": false,
  "certification": false,
  "delivery_estimate": true
}
```

**Output:**
```javascript
['Ki·ªÉm ƒë·ªãnh', 'V·∫≠n chuy·ªÉn']
```

#### **C. getStatusBadge() - C·∫£i thi·ªán Status**

‚úÖ **Th√™m status m·ªõi:**
```typescript
const config = {
  SUBMITTED: { variant: 'default', icon: Send, label: 'ƒê√£ g·ª≠i' },
  PENDING: { variant: 'default', icon: Clock, label: 'Ch·ªù x·ª≠ l√Ω' },
  AWAITING_RESPONSE: { variant: 'secondary', icon: Clock, label: 'Ch·ªù ph·∫£n h·ªìi' },
  QUOTED: { variant: 'default', icon: CheckCircle, label: 'ƒê√£ c√≥ b√°o gi√°' },
  ACCEPTED: { variant: 'default', icon: CheckCircle, label: 'ƒê√£ ch·∫•p nh·∫≠n' },
  COMPLETED: { variant: 'default', icon: CheckCircle, label: 'Ho√†n th√†nh' },
  REJECTED: { variant: 'destructive', icon: XCircle, label: 'ƒê√£ t·ª´ ch·ªëi' },
  EXPIRED: { variant: 'destructive', icon: XCircle, label: 'H·∫øt h·∫°n' },
  CANCELLED: { variant: 'outline', icon: XCircle, label: 'ƒê√£ h·ªßy' },
};
```

---

### **3. C·∫£i Thi·ªán Giao Di·ªán Table**

#### **A. Hi·ªÉn Th·ªã Th√¥ng Tin RFQ Chi Ti·∫øt H∆°n**

‚úÖ **C·ªôt "Y√™u c·∫ßu" - Hi·ªán t·∫°i:**

```tsx
<TableCell>
  <div className="space-y-1">
    {/* 1. Ti√™u ƒë·ªÅ listing */}
    <div className="font-medium">
      {rfq.listings?.title || 'Container'}
    </div>
    
    {/* 2. Purpose + Quantity + Container type */}
    <div className="flex flex-wrap items-center gap-2 text-xs">
      <Badge variant="outline">
        {getPurposeLabel(rfq.purpose)}
      </Badge>
      <div className="flex items-center gap-1">
        <Package className="h-3 w-3" />
        <span>SL: {rfq.quantity}</span>
      </div>
      {rfq.listings?.containers && (
        <span>
          {rfq.listings.containers.type} - {rfq.listings.containers.size_ft}ft
        </span>
      )}
    </div>
    
    {/* 3. Services */}
    {services.length > 0 && (
      <div className="flex flex-wrap gap-1 mt-1">
        {services.map((service, idx) => (
          <Badge key={idx} variant="secondary" className="text-xs">
            {service}
          </Badge>
        ))}
      </div>
    )}
    
    {/* 4. Need by date */}
    {rfq.need_by && (
      <div className="text-xs text-muted-foreground">
        C·∫ßn tr∆∞·ªõc: {new Date(rfq.need_by).toLocaleDateString('vi-VN')}
      </div>
    )}
  </div>
</TableCell>
```

**Hi·ªÉn th·ªã:**
```
Container 40HC Standard - Depot H·∫£i Ph√≤ng
[Mua] SL: 5 DRY - 40ft
[Ki·ªÉm ƒë·ªãnh] [V·∫≠n chuy·ªÉn]
C·∫ßn tr∆∞·ªõc: 01/11/2025
```

#### **B. C·ªôt "B√°o gi√°" - Hi·ªÉn Th·ªã Chi Ti·∫øt**

‚úÖ **Tr∆∞·ªõc:**
```tsx
<TableCell>
  {(rfq.quotes?.length || 0) > 0 ? (
    <Badge>3 b√°o gi√°</Badge>
  ) : (
    <span>Ch∆∞a c√≥</span>
  )}
</TableCell>
```

‚úÖ **Sau (Chi ti·∫øt h∆°n):**
```tsx
<TableCell>
  <div className="flex flex-col gap-1">
    {(rfq.quotes?.length || 0) > 0 ? (
      <>
        <Badge variant="default" className="w-fit">
          {rfq.quotes?.length} b√°o gi√°
        </Badge>
        {/* Hi·ªÉn th·ªã gi√° th·∫•p nh·∫•t */}
        {rfq.quotes && rfq.quotes[0].total && (
          <span className="text-xs text-muted-foreground">
            T·ª´ {new Intl.NumberFormat('vi-VN').format(
              parseFloat(rfq.quotes[0].total)
            )} {rfq.quotes[0].currency}
          </span>
        )}
      </>
    ) : (
      <span className="text-sm text-muted-foreground">Ch∆∞a c√≥</span>
    )}
  </div>
</TableCell>
```

**Hi·ªÉn th·ªã:**
```
[3 b√°o gi√°]
T·ª´ 110,000,000 VND
```

#### **C. Highlight RFQ H·∫øt H·∫°n**

```tsx
const isExpired = new Date(rfq.expired_at) < new Date();

<TableRow className={isExpired ? 'opacity-60' : ''}>
  {/* ... */}
  <TableCell>
    <div className="flex items-center gap-1 text-sm">
      <Clock className="h-3 w-3 text-muted-foreground" />
      <span className={isExpired ? 'text-red-500 font-medium' : ''}>
        {new Date(rfq.expired_at).toLocaleDateString('vi-VN')}
      </span>
    </div>
  </TableCell>
</TableRow>
```

**K·∫øt qu·∫£:**
- RFQ c√≤n h·∫°n: M√†u b√¨nh th∆∞·ªùng
- RFQ h·∫øt h·∫°n: Opacity 60%, ng√†y h·∫øt h·∫°n m√†u ƒë·ªè

---

### **4. S·ª≠a Stats Cards**

#### ‚úÖ **Card "Ch·ªù x·ª≠ l√Ω":**

```typescript
// TR∆Ø·ªöC: Ch·ªâ check status === 'pending'
{rfqs.filter(r => r.status === 'pending').length}

// SAU: Check c·∫£ SUBMITTED v√† PENDING (case-insensitive)
{rfqs.filter(r => 
  r.status.toUpperCase() === 'SUBMITTED' || 
  r.status.toUpperCase() === 'PENDING'
).length}
```

---

## üìä SO S√ÅNH TR∆Ø·ªöC/SAU

### **Hi·ªÉn Th·ªã RFQ Row:**

#### ‚ùå **TR∆Ø·ªöC:**
```
Container Request #123
M·ª•c ƒë√≠ch: PURCHASE
‚Ä¢ S·ªë l∆∞·ª£ng: 5
[Ch·ªù x·ª≠ l√Ω] [3 b√°o gi√°] 17/10/2025 24/10/2025 [Xem]
```

#### ‚úÖ **SAU:**
```
Container 40HC Standard - Depot H·∫£i Ph√≤ng
[Mua] SL: 5 DRY - 40ft
[Ki·ªÉm ƒë·ªãnh] [V·∫≠n chuy·ªÉn]
C·∫ßn tr∆∞·ªõc: 01/11/2025

[ƒê√£ g·ª≠i] 
[3 b√°o gi√°]
T·ª´ 110,000,000 VND
üìÖ 17/10/2025
‚è∞ 24/10/2025
[Xem]
```

---

## üóÇÔ∏è C·∫§U TR√öC DATA T·ª™ API

### **Backend API Response:**

```json
{
  "success": true,
  "data": [
    {
      "id": "rfq-uuid-123",
      "listing_id": "listing-uuid-456",
      "buyer_id": "buyer-uuid-789",
      "purpose": "PURCHASE",
      "quantity": 5,
      "need_by": "2025-11-01T00:00:00.000Z",
      "services_json": {
        "inspection": true,
        "repair_estimate": false,
        "certification": false,
        "delivery_estimate": true
      },
      "status": "SUBMITTED",
      "submitted_at": "2025-10-17T10:00:00.000Z",
      "expired_at": "2025-10-24T10:00:00.000Z",
      "created_at": "2025-10-17T10:00:00.000Z",
      "updated_at": "2025-10-17T10:00:00.000Z",
      "listings": {
        "id": "listing-uuid-456",
        "title": "Container 40HC Standard - Depot H·∫£i Ph√≤ng",
        "price_amount": "5000000.00",
        "price_currency": "VND",
        "containers": {
          "type": "DRY",
          "size_ft": 40
        }
      },
      "quotes": [
        {
          "id": "quote-uuid-111",
          "status": "SENT",
          "total": "110000000.00",
          "currency": "VND",
          "created_at": "2025-10-17T14:00:00.000Z"
        },
        {
          "id": "quote-uuid-222",
          "status": "SENT",
          "total": "115000000.00",
          "currency": "VND",
          "created_at": "2025-10-17T15:00:00.000Z"
        }
      ]
    }
  ]
}
```

---

## ‚úÖ CHECKLIST HO√ÄN TH√ÄNH

- [x] ‚úÖ S·ª≠a interface RFQ ƒë√∫ng v·ªõi API response
- [x] ‚úÖ Fix field names (price_amount, quotes type)
- [x] ‚úÖ Th√™m getPurposeLabel() helper
- [x] ‚úÖ Th√™m formatServices() helper
- [x] ‚úÖ C·∫£i thi·ªán getStatusBadge() v·ªõi status m·ªõi
- [x] ‚úÖ Hi·ªÉn th·ªã listing title t·ª´ relation
- [x] ‚úÖ Hi·ªÉn th·ªã container type v√† size
- [x] ‚úÖ Hi·ªÉn th·ªã services d∆∞·ªõi d·∫°ng badges
- [x] ‚úÖ Hi·ªÉn th·ªã need_by date
- [x] ‚úÖ Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng quotes v√† gi√° th·∫•p nh·∫•t
- [x] ‚úÖ Highlight RFQ h·∫øt h·∫°n
- [x] ‚úÖ Fix stats cards (check SUBMITTED status)
- [x] ‚úÖ Format s·ªë ti·ªÅn theo chu·∫©n VN
- [x] ‚úÖ Format ng√†y th√°ng theo chu·∫©n VN

---

## üé® C·∫¢I THI·ªÜN UI/UX

### **1. Th√¥ng tin hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß h∆°n:**
- ‚úÖ Listing title
- ‚úÖ Container type & size
- ‚úÖ Purpose (Mua/Thu√™)
- ‚úÖ Quantity
- ‚úÖ Services requested
- ‚úÖ Need by date

### **2. Visual indicators:**
- ‚úÖ Status badges v·ªõi m√†u s·∫Øc ph√π h·ª£p
- ‚úÖ Expired RFQs c√≥ opacity th·∫•p h∆°n
- ‚úÖ Expired date m√†u ƒë·ªè
- ‚úÖ Services hi·ªÉn th·ªã d·∫°ng badges

### **3. Data formatting:**
- ‚úÖ S·ªë ti·ªÅn: `110,000,000 VND`
- ‚úÖ Ng√†y th√°ng: `17/10/2025`
- ‚úÖ Purpose: `Mua` thay v√¨ `PURCHASE`

---

## üîÑ WORKFLOW HI·ªÇN TH·ªä

```
1. User v√†o /rfq/sent
   ‚Üì
2. Fetch API: GET /api/v1/rfqs?view=sent
   ‚Üì
3. Backend tr·∫£ v·ªÅ RFQs v·ªõi relations:
   - listings (title, price, containers)
   - quotes (count, total)
   ‚Üì
4. Frontend x·ª≠ l√Ω data:
   - Parse services_json
   - Convert purpose enum
   - Format dates & numbers
   - Check expired status
   ‚Üì
5. Hi·ªÉn th·ªã table v·ªõi:
   - Listing info + container type
   - Purpose badge + quantity
   - Services badges
   - Quotes count + lowest price
   - Dates v·ªõi highlighting
   ‚Üì
6. User click "Xem" ‚Üí /rfq/[id]
```

---

## üéØ K·∫æT QU·∫¢

### **‚úÖ Data Mapping: 100%**
- T·∫•t c·∫£ fields ƒë·ªÅu map ƒë√∫ng v·ªõi API response
- Kh√¥ng c√≤n field kh√¥ng t·ªìn t·∫°i
- Type ƒë√∫ng (string cho Decimal fields)

### **‚úÖ UI/UX: C·∫£i thi·ªán ƒë√°ng k·ªÉ**
- Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß th√¥ng tin RFQ
- Visual indicators r√µ r√†ng
- Format data chu·∫©n Vi·ªát Nam
- Responsive v√† d·ªÖ ƒë·ªçc

### **‚úÖ Functionality: Ho·∫°t ƒë·ªông ho√†n h·∫£o**
- Fetch data th√†nh c√¥ng
- Stats cards ch√≠nh x√°c
- Search ho·∫°t ƒë·ªông
- Expired detection ƒë√∫ng

---

## üí° L∆ØU √ù KHI S·ª¨ D·ª§NG

### **1. Backend API Response:**
- Backend tr·∫£ v·ªÅ `price_amount` v√† `total` d·∫°ng **string** (Prisma Decimal)
- Ph·∫£i d√πng `parseFloat()` tr∆∞·ªõc khi format number
- Status v√† Purpose l√† **UPPERCASE** t·ª´ enum

### **2. Services JSON:**
- Field `services_json` c√≥ th·ªÉ l√† `null` ho·∫∑c empty object
- Ph·∫£i check type tr∆∞·ªõc khi parse

### **3. Quotes Array:**
- C√≥ th·ªÉ empty array `[]`
- Sort theo `created_at` ƒë·ªÉ l·∫•y quote ƒë·∫ßu ti√™n (m·ªõi nh·∫•t)

### **4. Expired Check:**
- So s√°nh `expired_at` v·ªõi `new Date()`
- N·∫øu expired: opacity 60%, date m√†u ƒë·ªè

---

## üöÄ K·∫æT LU·∫¨N

Trang RFQ ƒë√£ g·ª≠i ƒë√£ ƒë∆∞·ª£c s·ª≠a ƒë·ªÉ:
- ‚úÖ S·ª≠ d·ª•ng 100% data th·∫≠t t·ª´ API
- ‚úÖ Hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß v√† chi ti·∫øt h∆°n
- ‚úÖ C·∫£i thi·ªán UI/UX ƒë√°ng k·ªÉ
- ‚úÖ Fix t·∫•t c·∫£ l·ªói field names
- ‚úÖ Th√™m visual indicators h·ªØu √≠ch
- ‚úÖ Format data chu·∫©n Vi·ªát Nam

**Trang hi·ªán ho√†n to√†n ch√≠nh x√°c v√† s·∫µn s√†ng production!** üéâ
