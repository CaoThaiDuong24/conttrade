<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Close Button - Driver.js</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.3.6/dist/driver.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
    }
    .test-element {
      padding: 20px;
      margin: 20px;
      border: 2px solid #ccc;
      background: #f5f5f5;
    }
    
    /* Override ƒë·ªÉ ƒë·∫£m b·∫£o close button ho·∫°t ƒë·ªông */
    .driver-popover-close-btn {
      pointer-events: auto !important;
      cursor: pointer !important;
      z-index: 999999999 !important;
      position: absolute !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    
    /* Override m·ªçi th·ª© c√≥ th·ªÉ block click */
    .driver-popover * {
      pointer-events: auto !important;
    }
  </style>
</head>
<body>
  <h1>Test Driver.js Close Button Debug</h1>
  
  <div class="test-element" id="element1">
    <h2>B∆∞·ªõc 1</h2>
    <p>N·ªôi dung test 1</p>
  </div>
  
  <div class="test-element" id="element2">
    <h2>B∆∞·ªõc 2</h2>
    <p>N·ªôi dung test 2</p>
  </div>
  
  <div class="test-element" id="element3">
    <h2>B∆∞·ªõc 3 (Cu·ªëi)</h2>
    <p>N·ªôi dung test 3</p>
  </div>

  <button onclick="startDebugTour()" style="padding: 10px 20px; font-size: 16px;">
    üöÄ B·∫Øt ƒë·∫ßu Test Tour
  </button>
  
  <button onclick="inspectButtons()" style="padding: 10px 20px; font-size: 16px; margin-left: 10px;">
    üîç Ki·ªÉm tra Buttons
  </button>

  <div id="log" style="margin-top: 20px; padding: 10px; background: #000; color: #0f0; font-family: monospace; max-height: 300px; overflow-y: auto;">
    <div>Log console:</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.6/dist/driver.iife.js"></script>
  <script>
    const logDiv = document.getElementById('log');
    
    function log(msg, color = '#0f0') {
      const div = document.createElement('div');
      div.style.color = color;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logDiv.appendChild(div);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(msg);
    }

    let driverInstance = null;

    function inspectButtons() {
      log('=== KI·ªÇM TRA BUTTONS ===', '#ff0');
      
      const closeBtn = document.querySelector('.driver-popover-close-btn');
      const doneBtn = document.querySelector('.driver-popover-done-btn');
      const nextBtn = document.querySelector('.driver-popover-next-btn');
      const prevBtn = document.querySelector('.driver-popover-prev-btn');
      
      log(`Close button: ${closeBtn ? 'T√åM TH·∫§Y' : 'KH√îNG T√åM TH·∫§Y'}`, closeBtn ? '#0f0' : '#f00');
      if (closeBtn) {
        const styles = window.getComputedStyle(closeBtn);
        log(`  - display: ${styles.display}`, '#ff0');
        log(`  - visibility: ${styles.visibility}`, '#ff0');
        log(`  - opacity: ${styles.opacity}`, '#ff0');
        log(`  - pointer-events: ${styles.pointerEvents}`, '#ff0');
        log(`  - z-index: ${styles.zIndex}`, '#ff0');
        log(`  - cursor: ${styles.cursor}`, '#ff0');
        log(`  - position: ${styles.position}`, '#ff0');
        
        // Test click directly
        closeBtn.addEventListener('click', () => {
          log('‚úÖ CLOSE BUTTON CLICKED SUCCESSFULLY!', '#0f0');
        }, { capture: true });
      }
      
      log(`Done button: ${doneBtn ? 'T√åM TH·∫§Y' : 'KH√îNG T√åM TH·∫§Y'}`, doneBtn ? '#0f0' : '#f00');
      log(`Next button: ${nextBtn ? 'T√åM TH·∫§Y' : 'KH√îNG T√åM TH·∫§Y'}`, nextBtn ? '#0f0' : '#f00');
      log(`Prev button: ${prevBtn ? 'T√åM TH·∫§Y' : 'KH√îNG T√åM TH·∫§Y'}`, prevBtn ? '#0f0' : '#f00');
    }

    function attachCustomHandlers(driver) {
      setTimeout(() => {
        log('üîß ƒêang attach custom handlers...', '#ff0');
        
        const closeBtn = document.querySelector('.driver-popover-close-btn');
        const doneBtn = document.querySelector('.driver-popover-done-btn');
        
        if (closeBtn) {
          log('‚úì T√¨m th·∫•y close button, ƒëang attach handler...', '#0ff');
          
          // Method 1: Capture phase
          closeBtn.addEventListener('click', (e) => {
            log('‚ùå CLOSE CLICKED (capture)', '#f0f');
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            driver.destroy();
          }, { capture: true });
          
          // Method 2: Normal phase
          closeBtn.addEventListener('click', (e) => {
            log('‚ùå CLOSE CLICKED (normal)', '#f0f');
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            driver.destroy();
          });
          
          // Method 3: Direct onclick
          closeBtn.onclick = (e) => {
            log('‚ùå CLOSE CLICKED (onclick)', '#f0f');
            e.preventDefault();
            e.stopPropagation();
            driver.destroy();
            return false;
          };
        }
        
        if (doneBtn) {
          log('‚úì T√¨m th·∫•y done button, ƒëang attach handler...', '#0ff');
          
          doneBtn.addEventListener('click', (e) => {
            log('‚úì DONE CLICKED (capture)', '#f0f');
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            driver.destroy();
          }, { capture: true });
          
          doneBtn.addEventListener('click', (e) => {
            log('‚úì DONE CLICKED (normal)', '#f0f');
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            driver.destroy();
          });
          
          doneBtn.onclick = (e) => {
            log('‚úì DONE CLICKED (onclick)', '#f0f');
            e.preventDefault();
            e.stopPropagation();
            driver.destroy();
            return false;
          };
        }
        
        log('‚úì Ho√†n th√†nh attach handlers', '#0f0');
      }, 200);
    }

    function startDebugTour() {
      log('=== B·∫ÆT ƒê·∫¶U DEBUG TOUR ===', '#ff0');
      
      const config = {
        showProgress: true,
        allowClose: true,
        overlayClickNext: false,
        smoothScroll: true,
        nextBtnText: 'Ti·∫øp theo ‚Üí',
        prevBtnText: '‚Üê Quay l·∫°i',
        doneBtnText: 'Ho√†n th√†nh ‚úì',
        onHighlighted: (element, step, opts) => {
          log(`Step highlighted: ${step.popover?.title}`, '#ff0');
          attachCustomHandlers(opts.driver);
          
          // Auto inspect after 100ms
          setTimeout(inspectButtons, 100);
        },
        onDestroyStarted: () => {
          log('‚ö†Ô∏è Tour ƒëang b·ªã destroy...', '#f00');
        },
        onDestroyed: () => {
          log('‚úì Tour ƒë√£ destroyed', '#0f0');
        },
        onPopoverRender: (popover) => {
          log('Popover rendered', '#0ff');
        },
        onNextClick: () => {
          log('Next button clicked', '#0ff');
        },
        onPrevClick: () => {
          log('Previous button clicked', '#0ff');
        },
        onCloseClick: () => {
          log('‚ùå CLOSE BUTTON CLICKED (callback)', '#f0f');
        }
      };
      
      const steps = [
        {
          element: '#element1',
          popover: {
            title: 'B∆∞·ªõc 1',
            description: 'Test b∆∞·ªõc 1 - Th·ª≠ click n√∫t X',
            side: 'right',
            align: 'start'
          }
        },
        {
          element: '#element2',
          popover: {
            title: 'B∆∞·ªõc 2',
            description: 'Test b∆∞·ªõc 2 - Th·ª≠ click n√∫t X',
            side: 'right',
            align: 'start'
          }
        },
        {
          element: '#element3',
          popover: {
            title: 'B∆∞·ªõc 3 (Cu·ªëi)',
            description: 'Test b∆∞·ªõc cu·ªëi - Th·ª≠ click n√∫t Ho√†n th√†nh',
            side: 'right',
            align: 'start'
          }
        }
      ];
      
      driverInstance = window.driver(config);
      driverInstance.setSteps(steps);
      driverInstance.drive();
      
      log('‚úì Driver instance created', '#0f0');
      
      // Attach handlers immediately
      attachCustomHandlers(driverInstance);
      
      // Auto inspect after tour starts
      setTimeout(inspectButtons, 300);
    }

    // Global access
    window.driverInstance = driverInstance;
    window.inspectButtons = inspectButtons;
    window.log = log;
    
    log('‚úì Test page loaded', '#0f0');
    log('Click "B·∫Øt ƒë·∫ßu Test Tour" ƒë·ªÉ test', '#ff0');
  </script>
</body>
</html>
