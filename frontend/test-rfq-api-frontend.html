<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test RFQ API - Frontend</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 5px;
    }
    button {
      background: #3498db;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background: #2980b9;
    }
    .result {
      margin-top: 20px;
      padding: 15px;
      background: #2c3e50;
      color: #ecf0f1;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .error {
      background: #e74c3c;
      color: white;
    }
    .success {
      background: #27ae60;
      color: white;
    }
    .info {
      background: #3498db;
      color: white;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #bdc3c7;
      border-radius: 5px;
      font-size: 14px;
    }
    .token-section {
      background: #fff3cd;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #ffc107;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Test RFQ API - Frontend Debug Tool</h1>
    
    <div class="info">
      <strong>üìå M·ª•c ƒë√≠ch:</strong> Ki·ªÉm tra API <code>/api/v1/rfqs?view=received</code> c√≥ tr·∫£ v·ªÅ ƒë·∫ßy ƒë·ªß d·ªØ li·ªáu kh√¥ng
    </div>

    <div class="token-section">
      <h3>üîë Access Token</h3>
      <p>Nh·∫≠p token t·ª´ cookies ho·∫∑c localStorage (ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ t·ª± ƒë·ªông l·∫•y):</p>
      <input type="text" id="tokenInput" placeholder="Bearer token (optional - auto-detect from cookies/localStorage)">
      <button onclick="detectToken()">üîç T·ª± ƒë·ªông ph√°t hi·ªán token</button>
    </div>

    <div class="test-section">
      <h3>üöÄ Test Actions</h3>
      <button onclick="testApi()">1Ô∏è‚É£ Test API /api/v1/rfqs?view=received</button>
      <button onclick="checkCookies()">2Ô∏è‚É£ Ki·ªÉm tra Cookies</button>
      <button onclick="checkLocalStorage()">3Ô∏è‚É£ Ki·ªÉm tra LocalStorage</button>
      <button onclick="clearResults()">üóëÔ∏è X√≥a k·∫øt qu·∫£</button>
    </div>

    <div id="results"></div>
  </div>

  <script>
    const resultsDiv = document.getElementById('results');
    const tokenInput = document.getElementById('tokenInput');

    function log(message, type = 'info') {
      const resultDiv = document.createElement('div');
      resultDiv.className = `result ${type}`;
      resultDiv.textContent = message;
      resultsDiv.appendChild(resultDiv);
    }

    function clearResults() {
      resultsDiv.innerHTML = '';
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function detectToken() {
      clearResults();
      log('üîç ƒêang t√¨m ki·∫øm token...', 'info');
      
      // Try cookies
      const cookieToken = getCookie('accessToken');
      if (cookieToken) {
        log(`‚úÖ T√¨m th·∫•y token trong cookies:\n${cookieToken.substring(0, 50)}...`, 'success');
        tokenInput.value = cookieToken;
        return cookieToken;
      }
      
      // Try localStorage
      const lsToken = localStorage.getItem('token') || localStorage.getItem('accessToken');
      if (lsToken) {
        log(`‚úÖ T√¨m th·∫•y token trong localStorage:\n${lsToken.substring(0, 50)}...`, 'success');
        tokenInput.value = lsToken;
        return lsToken;
      }
      
      log('‚ùå Kh√¥ng t√¨m th·∫•y token trong cookies ho·∫∑c localStorage', 'error');
      return null;
    }

    function checkCookies() {
      clearResults();
      log('=== üç™ COOKIES ===\n', 'info');
      
      const cookies = document.cookie.split(';');
      if (cookies.length === 0 || document.cookie === '') {
        log('‚ùå Kh√¥ng c√≥ cookies', 'error');
      } else {
        cookies.forEach(cookie => {
          const [name, ...valueParts] = cookie.split('=');
          const value = valueParts.join('=').trim();
          log(`${name.trim()}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`, 'info');
        });
      }
    }

    function checkLocalStorage() {
      clearResults();
      log('=== üíæ LOCAL STORAGE ===\n', 'info');
      
      if (localStorage.length === 0) {
        log('‚ùå LocalStorage tr·ªëng', 'error');
      } else {
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          log(`${key}: ${value.substring(0, 100)}${value.length > 100 ? '...' : ''}`, 'info');
        }
      }
    }

    async function testApi() {
      clearResults();
      log('üöÄ B·∫Øt ƒë·∫ßu test API...', 'info');
      
      // Get token
      let token = tokenInput.value.trim();
      if (!token) {
        token = getCookie('accessToken') || localStorage.getItem('token') || localStorage.getItem('accessToken');
      }
      
      if (!token) {
        log('‚ùå Kh√¥ng t√¨m th·∫•y token! Vui l√≤ng nh·∫≠p token ho·∫∑c ƒëƒÉng nh·∫≠p tr∆∞·ªõc.', 'error');
        return;
      }
      
      log(`‚úÖ S·ª≠ d·ª•ng token: ${token.substring(0, 30)}...`, 'success');
      
      // Call API
      const apiUrl = '/api/v1/rfqs?view=received';
      log(`\nüì° ƒêang g·ªçi API: ${apiUrl}`, 'info');
      
      try {
        const response = await fetch(apiUrl, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
          },
        });
        
        log(`\nüìä Response Status: ${response.status} ${response.statusText}`, 
          response.ok ? 'success' : 'error');
        
        log('\nüìã Response Headers:', 'info');
        for (const [key, value] of response.headers.entries()) {
          log(`  ${key}: ${value}`, 'info');
        }
        
        const responseText = await response.text();
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (e) {
          log('\n‚ùå Response kh√¥ng ph·∫£i JSON:', 'error');
          log(responseText, 'error');
          return;
        }
        
        if (response.ok) {
          log('\n‚úÖ API SUCCESS!', 'success');
          log(`\nüì¶ Response Data (${JSON.stringify(data).length} bytes):`, 'info');
          log(JSON.stringify(data, null, 2), 'info');
          
          if (data.data && Array.isArray(data.data)) {
            log(`\nüìä T·ªïng s·ªë RFQs: ${data.data.length}`, 'success');
            
            if (data.data.length > 0) {
              log('\nüîç Chi ti·∫øt RFQ ƒë·∫ßu ti√™n:', 'info');
              const firstRfq = data.data[0];
              
              log(`\nRFQ ID: ${firstRfq.id}`, 'info');
              log(`Status: ${firstRfq.status}`, 'info');
              log(`Buyer ID: ${firstRfq.buyer_id}`, 'info');
              log(`Listing: ${firstRfq.listings?.title || 'N/A'}`, 'info');
              
              if (firstRfq.users) {
                log(`\n‚úÖ users object t·ªìn t·∫°i:`, 'success');
                log(`  - email: ${firstRfq.users.email}`, 'info');
                log(`  - display_name: ${firstRfq.users.display_name || 'null'}`, 'info');
              } else {
                log(`\n‚ùå users object l√† NULL/undefined!`, 'error');
                log('ƒê√¢y ch√≠nh l√† l√Ω do hi·ªÉn th·ªã "Ng∆∞·ªùi mua kh√¥ng r√µ"', 'error');
              }
              
              log(`\nPurpose: ${firstRfq.purpose || 'null'}`, 'info');
              log(`Quantity: ${firstRfq.quantity || 'null'}`, 'info');
              log(`Quotes count: ${firstRfq.quotes?.length || 0}`, 'info');
            }
          }
        } else {
          log('\n‚ùå API ERROR!', 'error');
          log(JSON.stringify(data, null, 2), 'error');
        }
        
      } catch (error) {
        log('\n‚ùå FETCH ERROR:', 'error');
        log(error.toString(), 'error');
        log(error.stack, 'error');
      }
    }
  </script>
</body>
</html>
