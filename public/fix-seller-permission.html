<!DOCTYPE html>
<html>
<head>
    <title>Fix Seller Permission - Force Token Refresh</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        .section { background: #f5f5f5; padding: 15px; margin: 15px 0; border-radius: 5px; }
        .info { background: #e3f2fd; }
        .error { background: #ffebee; }
        .success { background: #e8f5e9; }
        .warning { background: #fff3e0; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #2196F3; color: white; border: none; }
        .btn-danger { background: #f44336; color: white; border: none; }
        .btn-success { background: #4CAF50; color: white; border: none; }
        pre { background: white; padding: 10px; overflow-x: auto; font-size: 12px; }
        h3 { margin-top: 0; }
    </style>
</head>
<body>
    <h1>üîß Fix Seller Permission Issue</h1>
    
    <div class="section warning">
        <h3>‚ö†Ô∏è V·∫•n ƒë·ªÅ hi·ªán t·∫°i:</h3>
        <p>Seller ƒë√£ ƒë∆∞·ª£c g√°n <code>CREATE_LISTING</code> permission nh∆∞ng v·∫´n b·ªã l·ªói 403 khi ƒëƒÉng tin.</p>
        <p><strong>Nguy√™n nh√¢n:</strong> Token c≈© kh√¥ng c√≥ permission m·ªõi ‚Üí C·∫ßn logout/login l·∫°i ƒë·ªÉ l·∫•y token m·ªõi.</p>
    </div>

    <div class="section info">
        <h3>üîç B∆∞·ªõc 1: Ki·ªÉm tra Token Hi·ªán T·∫°i</h3>
        <button class="btn-primary" onclick="checkCurrentToken()">Check Token</button>
        <div id="tokenInfo"></div>
    </div>

    <div class="section warning">
        <h3>üîÑ B∆∞·ªõc 2: Force Logout & Clear Token</h3>
        <button class="btn-danger" onclick="forceLogout()">Force Logout (Clear All Tokens)</button>
        <div id="logoutInfo"></div>
    </div>

    <div class="section success">
        <h3>‚úÖ B∆∞·ªõc 3: Login L·∫°i</h3>
        <p>Sau khi logout, h√£y:</p>
        <ol>
            <li>V√†o trang login: <a href="http://localhost:3000/vi/auth/login" target="_blank">http://localhost:3000/vi/auth/login</a></li>
            <li>ƒêƒÉng nh·∫≠p l·∫°i v·ªõi t√†i kho·∫£n seller</li>
            <li>Quay l·∫°i ƒë√¢y v√† click "Check Token" ƒë·ªÉ x√°c nh·∫≠n token m·ªõi c√≥ CREATE_LISTING</li>
        </ol>
    </div>

    <div class="section info">
        <h3>üß™ B∆∞·ªõc 4: Test T·∫°o Listing</h3>
        <button class="btn-success" onclick="testCreateListing()">Test Create Listing</button>
        <div id="testResult"></div>
    </div>

    <script>
        function checkCurrentToken() {
            const output = document.getElementById('tokenInfo');
            output.innerHTML = '<p>‚è≥ Checking...</p>';
            
            try {
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    output.innerHTML = '<div class="error"><strong>‚ùå No Token Found</strong><p>B·∫°n ch∆∞a login ho·∫∑c ƒë√£ logout.</p></div>';
                    return;
                }
                
                // Decode JWT
                const parts = token.split('.');
                const payload = JSON.parse(atob(parts[1]));
                
                const permissions = payload.permissions || [];
                const hasCreateListing = permissions.includes('CREATE_LISTING');
                
                const iat = new Date(payload.iat * 1000);
                const exp = new Date(payload.exp * 1000);
                const now = new Date();
                
                let html = '<div class="' + (hasCreateListing ? 'success' : 'error') + '">';
                html += '<h4>üìã Token Info:</h4>';
                html += '<pre>';
                html += 'Email: ' + payload.email + '\\n';
                html += 'User ID: ' + payload.userId + '\\n';
                html += 'Roles: ' + (payload.roles || []).join(', ') + '\\n';
                html += 'Total Permissions: ' + permissions.length + '\\n';
                html += 'Has CREATE_LISTING: ' + (hasCreateListing ? '‚úÖ YES' : '‚ùå NO') + '\\n';
                html += '\\nToken Issued: ' + iat.toLocaleString() + '\\n';
                html += 'Token Expires: ' + exp.toLocaleString() + '\\n';
                html += 'Is Expired: ' + (now > exp ? '‚ùå YES' : '‚úÖ NO');
                html += '</pre>';
                
                if (!hasCreateListing) {
                    html += '<p><strong>‚ö†Ô∏è Token KH√îNG c√≥ CREATE_LISTING permission!</strong></p>';
                    html += '<p>B·∫°n c·∫ßn logout v√† login l·∫°i ƒë·ªÉ l·∫•y token m·ªõi.</p>';
                }
                
                if (permissions.length > 0) {
                    html += '<details><summary>üìù All Permissions (' + permissions.length + ')</summary><pre>';
                    html += permissions.sort().join('\\n');
                    html += '</pre></details>';
                }
                
                html += '</div>';
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = '<div class="error"><strong>‚ùå Error:</strong> ' + error.message + '</div>';
            }
        }
        
        function forceLogout() {
            const output = document.getElementById('logoutInfo');
            
            // Clear all auth tokens
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            localStorage.removeItem('userInfo');
            
            // Clear cookies
            document.cookie.split(";").forEach(c => {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });
            
            output.innerHTML = '<div class="success"><strong>‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ tokens!</strong><p>B√¢y gi·ªù h√£y <a href="http://localhost:3000/vi/auth/login">login l·∫°i</a>.</p></div>';
        }
        
        async function testCreateListing() {
            const output = document.getElementById('testResult');
            output.innerHTML = '<p>‚è≥ Testing API call...</p>';
            
            try {
                const token = localStorage.getItem('access_token');
                
                if (!token) {
                    output.innerHTML = '<div class="error"><strong>‚ùå No token found!</strong><p>Please login first.</p></div>';
                    return;
                }
                
                // Test minimal listing creation
                const testData = {
                    dealType: 'SALE',
                    title: 'Test Listing - ' + new Date().toLocaleString(),
                    description: 'Test listing created by debug tool',
                    priceAmount: 1000,
                    priceCurrency: 'VND',
                    locationDepotId: 1,
                    facets: {}
                };
                
                const response = await fetch('http://localhost:3006/api/v1/listings', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                let html = '<div class="' + (response.ok ? 'success' : 'error') + '">';
                html += '<h4>üì° API Response:</h4>';
                html += '<p><strong>Status:</strong> ' + response.status + ' ' + response.statusText + '</p>';
                html += '<pre>' + JSON.stringify(result, null, 2) + '</pre>';
                
                if (!response.ok) {
                    if (response.status === 403) {
                        html += '<p><strong>‚ö†Ô∏è Still 403 Error!</strong></p>';
                        html += '<p>Token v·∫´n ch∆∞a c√≥ CREATE_LISTING permission. H√£y:</p>';
                        html += '<ol><li>Logout (click n√∫t "Force Logout" ·ªü tr√™n)</li>';
                        html += '<li>Login l·∫°i</li>';
                        html += '<li>Quay l·∫°i test l·∫°i</li></ol>';
                    }
                }
                
                html += '</div>';
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = '<div class="error"><strong>‚ùå Network Error:</strong><pre>' + error.message + '</pre></div>';
            }
        }
        
        // Auto check on load
        window.addEventListener('load', checkCurrentToken);
    </script>
</body>
</html>
