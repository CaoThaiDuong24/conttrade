name: Deploy to Ubuntu Server

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch:  # Cho phÃ©p trigger thá»§ cÃ´ng tá»« GitHub UI

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ðŸ”‘ Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: ðŸš€ Deploy to Server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT} ${SSH_USER}@${SSH_HOST} << 'ENDSSH'
            set -e
            
            echo "ðŸ”¹ Starting deployment process..."
            
            # Navigate to deployment directory
            cd ${DEPLOY_PATH}
            
            echo "ðŸ”¹ Pulling latest code from GitHub..."
            git fetch origin
            git reset --hard origin/master
            
            echo "ðŸ”¹ Installing/updating dependencies..."
            
            # Backend dependencies
            cd backend
            npm install --production
            
            # Run database migrations
            echo "ðŸ”¹ Running database migrations..."
            npx prisma generate
            npx prisma migrate deploy
            
            # Build backend
            echo "ðŸ”¹ Building backend..."
            npm run build
            
            # Frontend dependencies and build
            cd ../frontend
            npm install --production
            
            echo "ðŸ”¹ Building frontend..."
            npm run build
            
            # Return to root
            cd ..
            
            echo "ðŸ”¹ Restarting services with PM2..."
            pm2 reload ecosystem.config.js --update-env
            
            echo "ðŸ”¹ Checking application status..."
            pm2 list
            
            echo "âœ… Deployment completed successfully!"
            
          ENDSSH
      
      - name: ðŸ” Health Check
        run: |
          echo "Waiting 10 seconds for services to start..."
          sleep 10
          
          # Check if frontend is responding
          FRONTEND_STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://${{ secrets.SSH_HOST }}:3000 || echo "000")
          echo "Frontend status: $FRONTEND_STATUS"
          
          # Check if backend is responding
          BACKEND_STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://${{ secrets.SSH_HOST }}:3006/health || echo "000")
          echo "Backend status: $BACKEND_STATUS"
          
          if [ "$FRONTEND_STATUS" != "200" ] && [ "$FRONTEND_STATUS" != "000" ]; then
            echo "âš ï¸  Frontend health check: Status $FRONTEND_STATUS"
          fi
          
          if [ "$BACKEND_STATUS" != "200" ] && [ "$BACKEND_STATUS" != "000" ]; then
            echo "âš ï¸  Backend health check: Status $BACKEND_STATUS"
          fi
          
          echo "âœ… Health check completed"
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
      
      - name: ðŸ“¢ Notify Success
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "Frontend: http://${{ secrets.SSH_HOST }}:3000"
          echo "Backend: http://${{ secrets.SSH_HOST }}:3006"
      
      - name: ðŸ“¢ Notify Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Please check the logs above."
