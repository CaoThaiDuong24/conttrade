# üìã B√ÅO C√ÅO: B·ªï Sung Th√¥ng Tin Qu·∫£n L√Ω Container Cho Thu√™

**Ng√†y t·∫°o:** 30/10/2025  
**T√†i li·ªáu li√™n quan:** `HUONG-DAN-TOUR-SELL-NEW.md`  
**Trang ·∫£nh h∆∞·ªüng:** `/sell/new` (ƒêƒÉng tin m·ªõi)

---

## üéØ M·ª§C ƒê√çCH

Ph√¢n t√≠ch v√† ƒë·ªÅ xu·∫•t b·ªï sung c√°c tr∆∞·ªùng th√¥ng tin c·∫ßn thi·∫øt cho vi·ªác **qu·∫£n l√Ω ch·∫∑t ch·∫Ω s·ªë l∆∞·ª£ng Container cho thu√™** khi ng∆∞·ªùi b√°n ch·ªçn lo·∫°i giao d·ªãch **Cho Thu√™ (RENTAL/LEASE)**.

---

## üìä PH√ÇN T√çCH HI·ªÜN TR·∫†NG

### 1. C·∫•u Tr√∫c Database Hi·ªán T·∫°i

#### **Table: `listings`** (schema.prisma line 340-373)
```prisma
model listings {
  id                String           @id
  container_id      String?
  seller_user_id    String
  org_id            String?
  deal_type         DealType         // SALE, RENTAL, LEASE, AUCTION
  price_currency    String           @default("VND")
  price_amount      Decimal
  rental_unit       String?          // ‚úÖ ƒê√£ c√≥: DAY, WEEK, MONTH
  location_depot_id String?
  status            ListingStatus    @default(DRAFT)
  title             String
  description       String?
  features          Json?
  specifications    Json?
  view_count        Int              @default(0)
  favorite_count    Int              @default(0)
  published_at      DateTime?
  expires_at        DateTime?
  created_at        DateTime         @default(now())
  updated_at        DateTime
  deleted_at        DateTime?
  // Relations...
}
```

#### **Thi·∫øu c√°c tr∆∞·ªùng quan tr·ªçng:**
- ‚ùå **S·ªë l∆∞·ª£ng container c√≥ s·∫µn** (available_quantity)
- ‚ùå **S·ªë l∆∞·ª£ng ƒë√£ ƒë∆∞·ª£c thu√™** (rented_quantity)
- ‚ùå **S·ªë l∆∞·ª£ng ƒëang b·∫£o tr√¨** (maintenance_quantity)
- ‚ùå **Th·ªùi gian thu√™ t·ªëi thi·ªÉu** (min_rental_duration)
- ‚ùå **Th·ªùi gian thu√™ t·ªëi ƒëa** (max_rental_duration)
- ‚ùå **Ch√≠nh s√°ch ƒë·∫∑t c·ªçc** (deposit_policy)
- ‚ùå **Ti·ªÅn ƒë·∫∑t c·ªçc** (deposit_amount)
- ‚ùå **Ng√†y c√≥ th·ªÉ giao h√†ng s·ªõm nh·∫•t** (earliest_available_date)
- ‚ùå **Ch√≠nh s√°ch gia h·∫°n** (renewal_policy)
- ‚ùå **Ph√≠ ph·∫°t tr·∫£ mu·ªôn** (late_return_fee)

---

## üéØ ƒê·ªÄ XU·∫§T B·ªî SUNG

### 1. B·ªï Sung Database Schema

#### A. Th√™m tr∆∞·ªùng v√†o `listings` table

```sql
-- Migration: Add rental management fields to listings table
ALTER TABLE listings ADD COLUMN IF NOT EXISTS available_quantity INT DEFAULT 1;
ALTER TABLE listings ADD COLUMN IF NOT EXISTS rented_quantity INT DEFAULT 0;
ALTER TABLE listings ADD COLUMN IF NOT EXISTS reserved_quantity INT DEFAULT 0;
ALTER TABLE listings ADD COLUMN IF NOT EXISTS maintenance_quantity INT DEFAULT 0;
ALTER TABLE listings ADD COLUMN IF NOT EXISTS total_quantity INT DEFAULT 1;

-- Rental duration constraints
ALTER TABLE listings ADD COLUMN IF NOT EXISTS min_rental_duration INT; -- S·ªë l∆∞·ª£ng ƒë∆°n v·ªã (day/week/month)
ALTER TABLE listings ADD COLUMN IF NOT EXISTS max_rental_duration INT; -- S·ªë l∆∞·ª£ng ƒë∆°n v·ªã (day/week/month)

-- Deposit and fee policies
ALTER TABLE listings ADD COLUMN IF NOT EXISTS deposit_required BOOLEAN DEFAULT false;
ALTER TABLE listings ADD COLUMN IF NOT EXISTS deposit_amount DECIMAL(15,2);
ALTER TABLE listings ADD COLUMN IF NOT EXISTS deposit_currency VARCHAR(3);
ALTER TABLE listings ADD COLUMN IF NOT EXISTS late_return_fee_amount DECIMAL(15,2);
ALTER TABLE listings ADD COLUMN IF NOT EXISTS late_return_fee_unit VARCHAR(20); -- 'PER_DAY', 'PER_WEEK', 'PERCENTAGE'

-- Availability
ALTER TABLE listings ADD COLUMN IF NOT EXISTS earliest_available_date DATE;
ALTER TABLE listings ADD COLUMN IF NOT EXISTS latest_return_date DATE;

-- Renewal policy
ALTER TABLE listings ADD COLUMN IF NOT EXISTS auto_renewal_enabled BOOLEAN DEFAULT false;
ALTER TABLE listings ADD COLUMN IF NOT EXISTS renewal_notice_days INT DEFAULT 7;
ALTER TABLE listings ADD COLUMN IF NOT EXISTS renewal_price_adjustment DECIMAL(5,2); -- % increase/decrease

-- Tracking
ALTER TABLE listings ADD COLUMN IF NOT EXISTS last_rented_at TIMESTAMP;
ALTER TABLE listings ADD COLUMN IF NOT EXISTS total_rental_count INT DEFAULT 0;

-- Check constraint: available + rented + reserved + maintenance = total
ALTER TABLE listings ADD CONSTRAINT check_quantity_balance 
  CHECK (available_quantity + rented_quantity + reserved_quantity + maintenance_quantity = total_quantity);
```

#### B. C·∫≠p nh·∫≠t Prisma Schema

```prisma
model listings {
  id                String           @id
  container_id      String?
  seller_user_id    String
  org_id            String?
  deal_type         DealType
  price_currency    String           @default("VND")
  price_amount      Decimal
  rental_unit       String?
  
  // ============ üÜï RENTAL QUANTITY MANAGEMENT ============
  total_quantity            Int      @default(1)      // T·ªïng s·ªë container
  available_quantity        Int      @default(1)      // S·ªë l∆∞·ª£ng c√≥ s·∫µn cho thu√™
  rented_quantity           Int      @default(0)      // S·ªë l∆∞·ª£ng ƒëang ƒë∆∞·ª£c thu√™
  reserved_quantity         Int      @default(0)      // S·ªë l∆∞·ª£ng ƒë√£ ƒë·∫∑t tr∆∞·ªõc
  maintenance_quantity      Int      @default(0)      // S·ªë l∆∞·ª£ng ƒëang b·∫£o tr√¨
  
  // ============ üÜï RENTAL DURATION CONSTRAINTS ============
  min_rental_duration       Int?                      // Th·ªùi gian thu√™ t·ªëi thi·ªÉu (ƒë∆°n v·ªã theo rental_unit)
  max_rental_duration       Int?                      // Th·ªùi gian thu√™ t·ªëi ƒëa
  
  // ============ üÜï DEPOSIT & FEE POLICY ============
  deposit_required          Boolean  @default(false)  // C√≥ y√™u c·∫ßu ƒë·∫∑t c·ªçc kh√¥ng
  deposit_amount            Decimal?                  // S·ªë ti·ªÅn ƒë·∫∑t c·ªçc
  deposit_currency          String?                   // Ti·ªÅn t·ªá ƒë·∫∑t c·ªçc
  late_return_fee_amount    Decimal?                  // Ph√≠ tr·∫£ mu·ªôn
  late_return_fee_unit      String?                   // ƒê∆°n v·ªã ph√≠: PER_DAY, PER_WEEK, PERCENTAGE
  
  // ============ üÜï AVAILABILITY DATES ============
  earliest_available_date   DateTime?                 // Ng√†y s·ªõm nh·∫•t c√≥ th·ªÉ thu√™
  latest_return_date        DateTime?                 // Ng√†y ph·∫£i tr·∫£ l·∫°i mu·ªôn nh·∫•t
  
  // ============ üÜï RENEWAL POLICY ============
  auto_renewal_enabled      Boolean  @default(false)  // Cho ph√©p gia h·∫°n t·ª± ƒë·ªông
  renewal_notice_days       Int      @default(7)      // Th√¥ng b√°o tr∆∞·ªõc X ng√†y
  renewal_price_adjustment  Decimal? @default(0.00)   // % ƒëi·ªÅu ch·ªânh gi√° khi gia h·∫°n
  
  // ============ üÜï RENTAL TRACKING ============
  last_rented_at            DateTime?                 // L·∫ßn thu√™ g·∫ßn nh·∫•t
  total_rental_count        Int      @default(0)      // T·ªïng s·ªë l·∫ßn ƒë∆∞·ª£c thu√™
  
  // ... existing fields ...
  location_depot_id String?
  status            ListingStatus    @default(DRAFT)
  title             String
  description       String?
  // ... rest of fields ...
}
```

---

### 2. B·ªï Sung UI Form - Trang `/sell/new`

#### **Step 3: Rental Quantity Management** (M·ªõi th√™m v√†o sau Step Pricing)

Khi `deal_type === 'RENTAL' || deal_type === 'LEASE'`, hi·ªÉn th·ªã th√™m section:

```tsx
{/* Step: Rental Management - Ch·ªâ hi·ªÉn th·ªã khi ch·ªçn RENTAL/LEASE */}
{step === 'rental-management' && isRentalType(dealType) && (
  <div className="space-y-6">
    {/* A. Inventory Management */}
    <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
      <div className="flex items-center space-x-2 mb-4">
        <Package className="w-5 h-5 text-blue-600" />
        <h3 className="font-semibold text-gray-900">Qu·∫£n l√Ω s·ªë l∆∞·ª£ng container</h3>
      </div>
      
      <div className="grid grid-cols-2 gap-6">
        {/* Total Quantity */}
        <div className="space-y-2">
          <Label className="text-sm font-medium text-gray-900">
            T·ªïng s·ªë container c√≥ s·∫µn *
          </Label>
          <Input
            type="number"
            min="1"
            value={totalQuantity}
            onChange={(e) => setTotalQuantity(Number(e.target.value))}
            placeholder="VD: 10"
            className="h-10"
            required
          />
          <p className="text-xs text-gray-500">
            T·ªïng s·ªë container b·∫°n c√≥ th·ªÉ cho thu√™ ƒë·ªìng th·ªùi
          </p>
        </div>

        {/* Available Quantity */}
        <div className="space-y-2">
          <Label className="text-sm font-medium text-gray-900">
            S·ªë l∆∞·ª£ng hi·ªán c√≥ s·∫µn *
          </Label>
          <Input
            type="number"
            min="0"
            max={totalQuantity}
            value={availableQuantity}
            onChange={(e) => setAvailableQuantity(Number(e.target.value))}
            placeholder="VD: 8"
            className="h-10"
            required
          />
          <p className="text-xs text-gray-500">
            S·ªë container ƒëang s·∫µn s√†ng cho thu√™ ngay
          </p>
        </div>

        {/* In Maintenance */}
        <div className="space-y-2">
          <Label className="text-sm font-medium text-gray-900">
            ƒêang b·∫£o tr√¨
          </Label>
          <Input
            type="number"
            min="0"
            value={maintenanceQuantity}
            onChange={(e) => setMaintenanceQuantity(Number(e.target.value))}
            placeholder="VD: 2"
            className="h-10"
          />
          <p className="text-xs text-gray-500">
            S·ªë container ƒëang trong qu√° tr√¨nh b·∫£o tr√¨/s·ª≠a ch·ªØa
          </p>
        </div>

        {/* Summary Display */}
        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
          <h4 className="font-medium text-green-900 mb-3">T·ªïng quan</h4>
          <div className="space-y-2 text-sm">
            <div className="flex justify-between">
              <span className="text-gray-600">T·ªïng s·ªë:</span>
              <span className="font-semibold">{totalQuantity}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-600">C√≥ s·∫µn:</span>
              <span className="font-semibold text-green-600">{availableQuantity}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-600">ƒêang thu√™:</span>
              <span className="font-semibold">{rentedQuantity}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-600">B·∫£o tr√¨:</span>
              <span className="font-semibold text-yellow-600">{maintenanceQuantity}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    {/* B. Rental Duration Constraints */}
    <div className="bg-gray-50 rounded-lg p-6 border border-gray-200">
      <div className="flex items-center space-x-2 mb-4">
        <Clock className="w-5 h-5 text-blue-600" />
        <h3 className="font-semibold text-gray-900">Th·ªùi gian thu√™</h3>
      </div>
      
      <div className="grid grid-cols-2 gap-6">
        {/* Min Duration */}
        <div className="space-y-2">
          <Label className="text-sm font-medium text-gray-900">
            Th·ªùi gian thu√™ t·ªëi thi·ªÉu
          </Label>
          <div className="flex space-x-2">
            <Input
              type="number"
              min="1"
              value={minRentalDuration}
              onChange={(e) => setMinRentalDuration(Number(e.target.value))}
              placeholder="VD: 3"
              className="h-10 flex-1"
            />
            <Select value={rentalUnit} onValueChange={setRentalUnit} disabled>
              <SelectTrigger className="h-10 w-32">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {rentalUnits.data?.map((ru: any) => (
                  <SelectItem key={ru.code} value={ru.code}>
                    {ru.name}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <p className="text-xs text-gray-500">
            VD: T·ªëi thi·ªÉu 3 th√°ng
          </p>
        </div>

        {/* Max Duration */}
        <div className="space-y-2">
          <Label className="text-sm font-medium text-gray-900">
            Th·ªùi gian thu√™ t·ªëi ƒëa
          </Label>
          <div className="flex space-x-2">
            <Input
              type="number"
              min={minRentalDuration || 1}
              value={maxRentalDuration}
              onChange={(e) => setMaxRentalDuration(Number(e.target.value))}
              placeholder="VD: 12"
              className="h-10 flex-1"
            />
            <div className="h-10 w-32 flex items-center justify-center bg-gray-100 rounded-md text-sm text-gray-600">
              {rentalUnits.data?.find(ru => ru.code === rentalUnit)?.name || rentalUnit}
            </div>
          </div>
          <p className="text-xs text-gray-500">
            VD: T·ªëi ƒëa 12 th√°ng (ƒë·ªÉ tr·ªëng = kh√¥ng gi·ªõi h·∫°n)
          </p>
        </div>
      </div>
    </div>

    {/* C. Deposit & Fee Policy */}
    <div className="bg-yellow-50 rounded-lg p-6 border border-yellow-200">
      <div className="flex items-center space-x-2 mb-4">
        <DollarSign className="w-5 h-5 text-yellow-600" />
        <h3 className="font-semibold text-gray-900">Ch√≠nh s√°ch ƒë·∫∑t c·ªçc & ph√≠</h3>
      </div>
      
      {/* Deposit Required Toggle */}
      <div className="flex items-center justify-between mb-4 p-3 bg-white rounded-lg">
        <div>
          <Label className="text-sm font-medium text-gray-900">
            Y√™u c·∫ßu ƒë·∫∑t c·ªçc
          </Label>
          <p className="text-xs text-gray-500 mt-1">
            Kh√°ch h√†ng ph·∫£i ƒë·∫∑t c·ªçc tr∆∞·ªõc khi thu√™
          </p>
        </div>
        <Switch
          checked={depositRequired}
          onCheckedChange={setDepositRequired}
        />
      </div>

      {depositRequired && (
        <div className="grid grid-cols-2 gap-6 mt-4">
          {/* Deposit Amount */}
          <div className="space-y-2">
            <Label className="text-sm font-medium text-gray-900">
              S·ªë ti·ªÅn ƒë·∫∑t c·ªçc *
            </Label>
            <div className="flex space-x-2">
              <Input
                type="number"
                min="0"
                value={depositAmount}
                onChange={(e) => setDepositAmount(Number(e.target.value))}
                placeholder="VD: 5000000"
                className="h-10 flex-1"
                required={depositRequired}
              />
              <Select 
                value={depositCurrency || priceCurrency} 
                onValueChange={setDepositCurrency}
              >
                <SelectTrigger className="h-10 w-24">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {currencies.data?.map((cur: any) => (
                    <SelectItem key={cur.code} value={cur.code}>
                      {cur.code}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <p className="text-xs text-gray-500">
              Th∆∞·ªùng b·∫±ng 20-50% gi√° thu√™ 1 k·ª≥
            </p>
          </div>

          {/* Late Return Fee */}
          <div className="space-y-2">
            <Label className="text-sm font-medium text-gray-900">
              Ph√≠ tr·∫£ mu·ªôn (t√πy ch·ªçn)
            </Label>
            <div className="flex space-x-2">
              <Input
                type="number"
                min="0"
                value={lateReturnFeeAmount}
                onChange={(e) => setLateReturnFeeAmount(Number(e.target.value))}
                placeholder="VD: 100000"
                className="h-10 flex-1"
              />
              <Select 
                value={lateReturnFeeUnit} 
                onValueChange={setLateReturnFeeUnit}
              >
                <SelectTrigger className="h-10 w-32">
                  <SelectValue placeholder="ƒê∆°n v·ªã" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="PER_DAY">/ Ng√†y</SelectItem>
                  <SelectItem value="PER_WEEK">/ Tu·∫ßn</SelectItem>
                  <SelectItem value="PERCENTAGE">% Gi√° thu√™</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <p className="text-xs text-gray-500">
              Ph√≠ ph·∫°t khi kh√°ch h√†ng tr·∫£ container mu·ªôn h·∫°n
            </p>
          </div>
        </div>
      )}
    </div>

    {/* D. Availability Dates */}
    <div className="bg-green-50 rounded-lg p-6 border border-green-200">
      <div className="flex items-center space-x-2 mb-4">
        <Calendar className="w-5 h-5 text-green-600" />
        <h3 className="font-semibold text-gray-900">Ng√†y c√≥ th·ªÉ thu√™</h3>
      </div>
      
      <div className="grid grid-cols-2 gap-6">
        {/* Earliest Available Date */}
        <div className="space-y-2">
          <Label className="text-sm font-medium text-gray-900">
            S·ªõm nh·∫•t c√≥ th·ªÉ giao (t√πy ch·ªçn)
          </Label>
          <Input
            type="date"
            value={earliestAvailableDate}
            onChange={(e) => setEarliestAvailableDate(e.target.value)}
            min={new Date().toISOString().split('T')[0]}
            className="h-10"
          />
          <p className="text-xs text-gray-500">
            Ng√†y s·ªõm nh·∫•t kh√°ch c√≥ th·ªÉ nh·∫≠n container
          </p>
        </div>

        {/* Latest Return Date */}
        <div className="space-y-2">
          <Label className="text-sm font-medium text-gray-900">
            Mu·ªôn nh·∫•t ph·∫£i tr·∫£ (t√πy ch·ªçn)
          </Label>
          <Input
            type="date"
            value={latestReturnDate}
            onChange={(e) => setLatestReturnDate(e.target.value)}
            min={earliestAvailableDate || new Date().toISOString().split('T')[0]}
            className="h-10"
          />
          <p className="text-xs text-gray-500">
            Ch·ªâ d√πng cho thu√™ ng·∫Øn h·∫°n c√≥ th·ªùi h·∫°n c·ªë ƒë·ªãnh
          </p>
        </div>
      </div>
    </div>

    {/* E. Renewal Policy */}
    <div className="bg-purple-50 rounded-lg p-6 border border-purple-200">
      <div className="flex items-center space-x-2 mb-4">
        <RefreshCw className="w-5 h-5 text-purple-600" />
        <h3 className="font-semibold text-gray-900">Ch√≠nh s√°ch gia h·∫°n</h3>
      </div>
      
      {/* Auto Renewal Toggle */}
      <div className="flex items-center justify-between mb-4 p-3 bg-white rounded-lg">
        <div>
          <Label className="text-sm font-medium text-gray-900">
            Cho ph√©p gia h·∫°n t·ª± ƒë·ªông
          </Label>
          <p className="text-xs text-gray-500 mt-1">
            Kh√°ch h√†ng c√≥ th·ªÉ gia h·∫°n h·ª£p ƒë·ªìng thu√™
          </p>
        </div>
        <Switch
          checked={autoRenewalEnabled}
          onCheckedChange={setAutoRenewalEnabled}
        />
      </div>

      {autoRenewalEnabled && (
        <div className="grid grid-cols-2 gap-6 mt-4">
          {/* Notice Days */}
          <div className="space-y-2">
            <Label className="text-sm font-medium text-gray-900">
              Th√¥ng b√°o tr∆∞·ªõc (ng√†y)
            </Label>
            <Input
              type="number"
              min="1"
              max="30"
              value={renewalNoticeDays}
              onChange={(e) => setRenewalNoticeDays(Number(e.target.value))}
              placeholder="VD: 7"
              className="h-10"
            />
            <p className="text-xs text-gray-500">
              Th√¥ng b√°o kh√°ch h√†ng tr∆∞·ªõc X ng√†y h·∫øt h·∫°n
            </p>
          </div>

          {/* Price Adjustment */}
          <div className="space-y-2">
            <Label className="text-sm font-medium text-gray-900">
              ƒêi·ªÅu ch·ªânh gi√° khi gia h·∫°n (%)
            </Label>
            <div className="flex space-x-2">
              <Input
                type="number"
                step="0.1"
                value={renewalPriceAdjustment}
                onChange={(e) => setRenewalPriceAdjustment(Number(e.target.value))}
                placeholder="VD: 5"
                className="h-10 flex-1"
              />
              <div className="h-10 w-16 flex items-center justify-center bg-gray-100 rounded-md text-sm text-gray-600">
                %
              </div>
            </div>
            <p className="text-xs text-gray-500">
              (+) tƒÉng gi√°, (-) gi·∫£m gi√°, (0) gi·ªØ nguy√™n
            </p>
          </div>
        </div>
      )}
    </div>
  </div>
)}
```

---

### 3. C·∫≠p Nh·∫≠t Tour Guide Steps

Th√™m v√†o `frontend/lib/tour/driver-config.ts`:

```typescript
export const sellNewTourSteps: DriveStep[] = [
  // ... existing 15 steps ...
  
  // ‚úÖ NEW STEP 16: Rental Management (only for RENTAL/LEASE)
  {
    element: '#rental-management-section',
    popover: {
      title: 'üì¶ Qu·∫£n L√Ω Container Cho Thu√™',
      description: 'Thi·∫øt l·∫≠p s·ªë l∆∞·ª£ng container, th·ªùi gian thu√™, ƒë·∫∑t c·ªçc v√† ch√≠nh s√°ch gia h·∫°n.',
      side: 'bottom',
      align: 'center',
    },
  },
  
  // ‚úÖ NEW STEP 17: Quantity Management
  {
    element: '#quantity-inventory-section',
    popover: {
      title: 'üî¢ S·ªë L∆∞·ª£ng Container',
      description: 'Nh·∫≠p t·ªïng s·ªë container v√† s·ªë l∆∞·ª£ng hi·ªán c√≥ s·∫µn. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông theo d√µi s·ªë l∆∞·ª£ng ƒë√£ thu√™ v√† ƒëang b·∫£o tr√¨.',
      side: 'right',
      align: 'start',
    },
  },
  
  // ‚úÖ NEW STEP 18: Duration Constraints
  {
    element: '#rental-duration-section',
    popover: {
      title: '‚è∞ Th·ªùi Gian Thu√™',
      description: 'ƒê·∫∑t th·ªùi gian thu√™ t·ªëi thi·ªÉu v√† t·ªëi ƒëa ƒë·ªÉ ki·ªÉm so√°t chu k·ª≥ cho thu√™ container.',
      side: 'left',
      align: 'start',
    },
  },
  
  // ‚úÖ NEW STEP 19: Deposit Policy
  {
    element: '#deposit-policy-section',
    popover: {
      title: 'üí∞ Ch√≠nh S√°ch ƒê·∫∑t C·ªçc',
      description: 'B·∫≠t t√πy ch·ªçn y√™u c·∫ßu ƒë·∫∑t c·ªçc v√† thi·∫øt l·∫≠p ph√≠ tr·∫£ mu·ªôn ƒë·ªÉ b·∫£o v·ªá t√†i s·∫£n.',
      side: 'bottom',
      align: 'center',
    },
  },
  
  // ‚úÖ NEW STEP 20: Renewal Policy
  {
    element: '#renewal-policy-section',
    popover: {
      title: 'üîÑ Ch√≠nh S√°ch Gia H·∫°n',
      description: 'Cho ph√©p kh√°ch h√†ng gia h·∫°n h·ª£p ƒë·ªìng thu√™ t·ª± ƒë·ªông v√† ƒëi·ªÅu ch·ªânh gi√° n·∫øu c·∫ßn.',
      side: 'top',
      align: 'center',
    },
  },
];
```

---

### 4. Validation Logic B·ªï Sung

```typescript
const validateRentalStep = (): boolean => {
  if (!isRentalType(dealType)) return true; // Skip if not rental
  
  const errors: string[] = [];
  
  // Quantity validation
  if (!totalQuantity || totalQuantity < 1) {
    errors.push('T·ªïng s·ªë container ph·∫£i >= 1');
  }
  
  if (!availableQuantity || availableQuantity < 0) {
    errors.push('S·ªë l∆∞·ª£ng c√≥ s·∫µn kh√¥ng ƒë∆∞·ª£c √¢m');
  }
  
  if (availableQuantity > totalQuantity) {
    errors.push('S·ªë l∆∞·ª£ng c√≥ s·∫µn kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n t·ªïng s·ªë');
  }
  
  const totalAccounted = availableQuantity + rentedQuantity + maintenanceQuantity;
  if (totalAccounted !== totalQuantity) {
    errors.push(`T·ªïng s·ªë ph√¢n b·ªï (${totalAccounted}) ph·∫£i b·∫±ng t·ªïng s·ªë container (${totalQuantity})`);
  }
  
  // Duration validation
  if (minRentalDuration && maxRentalDuration) {
    if (minRentalDuration > maxRentalDuration) {
      errors.push('Th·ªùi gian thu√™ t·ªëi thi·ªÉu kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n t·ªëi ƒëa');
    }
  }
  
  // Deposit validation
  if (depositRequired) {
    if (!depositAmount || depositAmount <= 0) {
      errors.push('S·ªë ti·ªÅn ƒë·∫∑t c·ªçc ph·∫£i > 0 khi b·∫≠t y√™u c·∫ßu ƒë·∫∑t c·ªçc');
    }
    if (!depositCurrency) {
      errors.push('Vui l√≤ng ch·ªçn ti·ªÅn t·ªá ƒë·∫∑t c·ªçc');
    }
  }
  
  // Date validation
  if (earliestAvailableDate && latestReturnDate) {
    const earliest = new Date(earliestAvailableDate);
    const latest = new Date(latestReturnDate);
    if (earliest >= latest) {
      errors.push('Ng√†y giao s·ªõm nh·∫•t ph·∫£i tr∆∞·ªõc ng√†y tr·∫£ mu·ªôn nh·∫•t');
    }
  }
  
  if (errors.length > 0) {
    toast({
      title: "L·ªói validation",
      description: errors[0],
      variant: "destructive",
    });
    return false;
  }
  
  return true;
};
```

---

### 5. API Endpoint C·∫ßn C·∫≠p Nh·∫≠t

#### **POST `/api/v1/listings`** - Create Listing

**Request Body** (b·ªï sung):
```json
{
  "dealType": "RENTAL",
  "priceAmount": 5000000,
  "priceCurrency": "VND",
  "rentalUnit": "MONTH",
  
  // ‚úÖ NEW FIELDS
  "totalQuantity": 10,
  "availableQuantity": 8,
  "maintenanceQuantity": 2,
  "minRentalDuration": 3,
  "maxRentalDuration": 12,
  "depositRequired": true,
  "depositAmount": 2500000,
  "depositCurrency": "VND",
  "lateReturnFeeAmount": 100000,
  "lateReturnFeeUnit": "PER_DAY",
  "earliestAvailableDate": "2025-11-01",
  "autoRenewalEnabled": true,
  "renewalNoticeDays": 7,
  "renewalPriceAdjustment": 5.0,
  
  // ... existing fields
}
```

#### **Backend Controller** (`backend/controllers/listingController.js`)

```javascript
// ‚úÖ Add rental management fields validation
const validateRentalFields = (data) => {
  const { dealType, totalQuantity, availableQuantity, depositRequired, depositAmount } = data;
  
  if (dealType === 'RENTAL' || dealType === 'LEASE') {
    // Validate quantity
    if (!totalQuantity || totalQuantity < 1) {
      throw new Error('Total quantity must be >= 1 for rental listings');
    }
    
    if (availableQuantity > totalQuantity) {
      throw new Error('Available quantity cannot exceed total quantity');
    }
    
    // Validate deposit
    if (depositRequired && (!depositAmount || depositAmount <= 0)) {
      throw new Error('Deposit amount is required when deposit is enabled');
    }
  }
};

exports.createListing = async (req, res) => {
  try {
    const listingData = req.body;
    
    // Validate rental fields
    validateRentalFields(listingData);
    
    // Create listing with rental management fields
    const listing = await prisma.listings.create({
      data: {
        ...listingData,
        // Map rental management fields
        total_quantity: listingData.totalQuantity || 1,
        available_quantity: listingData.availableQuantity || 1,
        maintenance_quantity: listingData.maintenanceQuantity || 0,
        min_rental_duration: listingData.minRentalDuration,
        max_rental_duration: listingData.maxRentalDuration,
        deposit_required: listingData.depositRequired || false,
        deposit_amount: listingData.depositAmount,
        deposit_currency: listingData.depositCurrency,
        late_return_fee_amount: listingData.lateReturnFeeAmount,
        late_return_fee_unit: listingData.lateReturnFeeUnit,
        earliest_available_date: listingData.earliestAvailableDate,
        auto_renewal_enabled: listingData.autoRenewalEnabled || false,
        renewal_notice_days: listingData.renewalNoticeDays || 7,
        renewal_price_adjustment: listingData.renewalPriceAdjustment,
      },
    });
    
    return res.json({ success: true, data: { listing } });
  } catch (error) {
    console.error('Create listing error:', error);
    return res.status(400).json({ success: false, error: error.message });
  }
};
```

---

## üìã CHECKLIST TRI·ªÇN KHAI

### Phase 1: Database Migration
- [ ] T·∫°o migration file ƒë·ªÉ th√™m c√°c c·ªôt m·ªõi v√†o `listings` table
- [ ] Ch·∫°y migration tr√™n development database
- [ ] Ki·ªÉm tra constraint `check_quantity_balance` ho·∫°t ƒë·ªông
- [ ] C·∫≠p nh·∫≠t Prisma schema
- [ ] Generate Prisma client m·ªõi

### Phase 2: Backend API
- [ ] C·∫≠p nh·∫≠t `listingController.js` ƒë·ªÉ x·ª≠ l√Ω rental management fields
- [ ] Th√™m validation logic cho rental fields
- [ ] C·∫≠p nh·∫≠t Swagger/API documentation
- [ ] Vi·∫øt unit tests cho rental validation
- [ ] Test API v·ªõi Postman/Thunder Client

### Phase 3: Frontend UI
- [ ] Th√™m state variables cho rental management fields
- [ ] T·∫°o UI components cho Rental Management step
- [ ] C·∫≠p nh·∫≠t step flow (th√™m step m·ªõi sau Pricing)
- [ ] Implement validation logic
- [ ] Th√™m IDs cho tour guide
- [ ] Update form submission logic

### Phase 4: Tour Guide
- [ ] Th√™m 5 steps m·ªõi v√†o `driver-config.ts`
- [ ] Test tour guide v·ªõi rental listing
- [ ] C·∫≠p nh·∫≠t documentation `HUONG-DAN-TOUR-SELL-NEW.md`

### Phase 5: Testing
- [ ] Test t·∫°o listing SALE (kh√¥ng c√≥ rental fields)
- [ ] Test t·∫°o listing RENTAL v·ªõi ƒë·∫ßy ƒë·ªß th√¥ng tin
- [ ] Test validation errors
- [ ] Test quantity constraint (available + rented + maintenance = total)
- [ ] Test deposit required/not required
- [ ] Test renewal policy
- [ ] Test responsive UI tr√™n mobile

### Phase 6: Documentation
- [ ] C·∫≠p nh·∫≠t API documentation
- [ ] C·∫≠p nh·∫≠t user guide
- [ ] T·∫°o admin guide cho qu·∫£n l√Ω rental listings
- [ ] Screenshot UI m·ªõi

---

## üéØ L·ª¢I √çCH

### 1. **Qu·∫£n L√Ω Ch·∫∑t Ch·∫Ω S·ªë L∆∞·ª£ng**
- Theo d√µi ch√≠nh x√°c s·ªë container c√≥ s·∫µn vs ƒëang thu√™
- T·ª± ƒë·ªông c·∫≠p nh·∫≠t khi c√≥ booking m·ªõi
- NgƒÉn ch·∫∑n overbooking (cho thu√™ qu√° s·ªë l∆∞·ª£ng)

### 2. **B·∫£o V·ªá T√†i S·∫£n**
- Y√™u c·∫ßu ƒë·∫∑t c·ªçc ƒë·ªÉ gi·∫£m r·ªßi ro
- Ph√≠ tr·∫£ mu·ªôn khuy·∫øn kh√≠ch tu√¢n th·ªß th·ªùi h·∫°n
- Theo d√µi l·ªãch s·ª≠ cho thu√™

### 3. **T·ª± ƒê·ªông H√≥a**
- Ch√≠nh s√°ch gia h·∫°n t·ª± ƒë·ªông
- Th√¥ng b√°o tr∆∞·ªõc khi h·∫øt h·∫°n
- ƒêi·ªÅu ch·ªânh gi√° linh ho·∫°t

### 4. **Tr·∫£i Nghi·ªám Kh√°ch H√†ng T·ªët**
- Th√¥ng tin minh b·∫°ch v·ªÅ s·ªë l∆∞·ª£ng c√≥ s·∫µn
- Bi·∫øt r√µ th·ªùi gian thu√™ t·ªëi thi·ªÉu/t·ªëi ƒëa
- Ch√≠nh s√°ch r√µ r√†ng v·ªÅ ƒë·∫∑t c·ªçc v√† ph√≠

### 5. **B√°o C√°o & Ph√¢n T√≠ch**
- Th·ªëng k√™ s·ªë l·∫ßn ƒë∆∞·ª£c thu√™
- T·ª∑ l·ªá s·ª≠ d·ª•ng container
- Doanh thu t·ª´ rental
- Th·ªùi gian trung b√¨nh m·ªói l·∫ßn thu√™

---

## üîÑ BUSINESS FLOW M·ªöI

### Khi T·∫°o Listing Rental:
1. Seller nh·∫≠p t·ªïng s·ªë container: 10
2. Seller nh·∫≠p s·ªë l∆∞·ª£ng c√≥ s·∫µn: 8
3. Seller nh·∫≠p s·ªë ƒëang b·∫£o tr√¨: 2
4. System t·ª± ƒë·ªông t√≠nh `rented_quantity = 0` (ban ƒë·∫ßu)
5. System check: 8 + 0 + 2 = 10 ‚úÖ

### Khi Buyer Book Container:
1. Buyer ch·ªçn quantity: 3
2. System ki·ªÉm tra: `availableQuantity >= 3` ?
3. N·∫øu OK:
   - `availableQuantity -= 3` (8 ‚Üí 5)
   - `rented_quantity += 3` (0 ‚Üí 3)
   - `reserved_quantity += 3` (t·∫°m th·ªùi reserve)
4. Sau khi thanh to√°n th√†nh c√¥ng:
   - `reserved_quantity -= 3`
   - Chuy·ªÉn sang tr·∫°ng th√°i RENTED

### Khi Buyer Tr·∫£ Container:
1. Buyer confirm tr·∫£ container
2. System ki·ªÉm tra ng√†y tr·∫£:
   - N·∫øu ƒë√∫ng h·∫°n: Ho√†n ti·ªÅn c·ªçc 100%
   - N·∫øu mu·ªôn: T√≠nh ph√≠ tr·∫£ mu·ªôn, tr·ª´ v√†o ti·ªÅn c·ªçc
3. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng:
   - `rented_quantity -= 3` (3 ‚Üí 0)
   - `availableQuantity += 3` (5 ‚Üí 8)
4. TƒÉng `total_rental_count += 1`

---

## üìä M·∫™U HI·ªÇN TH·ªä CHO BUYER

### Listing Card
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Container 40ft Dry - Cho thu√™           ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ üí∞ 5,000,000 VND / th√°ng               ‚îÇ
‚îÇ üì¶ C√≥ s·∫µn: 8/10 container              ‚îÇ
‚îÇ ‚è∞ Thu√™ t·ªëi thi·ªÉu: 3 th√°ng             ‚îÇ
‚îÇ üíµ ƒê·∫∑t c·ªçc: 2,500,000 VND              ‚îÇ
‚îÇ üìÖ Giao s·ªõm nh·∫•t: 01/11/2025           ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [ƒê·∫∑t thu√™ ngay]                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Booking Form
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ S·ªë l∆∞·ª£ng c·∫ßn thu√™: [___] (T·ªëi ƒëa: 8)  ‚îÇ
‚îÇ Th·ªùi gian thu√™: [___] th√°ng            ‚îÇ
‚îÇ   (T·ªëi thi·ªÉu: 3 th√°ng, T·ªëi ƒëa: 12)    ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ T√≥m t·∫Øt:                               ‚îÇ
‚îÇ - Gi√° thu√™: 5,000,000 x 3 = 15,000,000‚îÇ
‚îÇ - ƒê·∫∑t c·ªçc: 2,500,000 VND               ‚îÇ
‚îÇ - T·ªïng thanh to√°n: 17,500,000 VND      ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ [X√°c nh·∫≠n ƒë·∫∑t thu√™]                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéâ K·∫æT LU·∫¨N

B·ªï sung c√°c tr∆∞·ªùng th√¥ng tin qu·∫£n l√Ω container cho thu√™ s·∫Ω:

‚úÖ **TƒÉng t√≠nh chuy√™n nghi·ªáp** c·ªßa platform  
‚úÖ **B·∫£o v·ªá l·ª£i √≠ch** ng∆∞·ªùi cho thu√™ v√† ng∆∞·ªùi thu√™  
‚úÖ **T·ª± ƒë·ªông h√≥a** quy tr√¨nh qu·∫£n l√Ω  
‚úÖ **Gi·∫£m thi·ªÉu tranh ch·∫•p** nh·ªù ch√≠nh s√°ch r√µ r√†ng  
‚úÖ **Cung c·∫•p data** cho b√°o c√°o v√† ph√¢n t√≠ch  

---

**Ng∆∞·ªùi t·∫°o:** GitHub Copilot  
**Ng√†y c·∫≠p nh·∫≠t cu·ªëi:** 30/10/2025  
**Version:** 1.0  
